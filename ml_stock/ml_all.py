# -*- coding: UTF-8 -*-
import matplotlib;matplotlib.use('Agg')
import matplotlib.pyplot as plt
import tushare as ts
ts.set_token('198b6f660ced07990c5919fc0f8955b56f8e155bc47c39b3e46ecf03')
import data.preprocess_data as prep_d
import data.data_const as dtcst
import ml_const as mlcst
import numpy as np
import data.util as util
import pandas as pd
import warnings
warnings.filterwarnings('ignore')

def ml_all(realtime_data):
    code_func_map = util.code_func_map()
    predict_table = pd.DataFrame(columns=mlcst.attributes)
    basic_env = pd.read_csv(dtcst.My_Store_Dir+'basic.csv',index_col='code')
    predict_table['Code_Index'] = dtcst.My_Wanted_codes
    predict_table = predict_table.set_index("Code_Index")
    i=1;codes = dtcst.My_Wanted_codes;print code_func_map.keys()[:30],'codes length:',len(codes)
    codata_basic_code_mapping = {}
    for code in codes:
        print '\n',i,'/',len(codes),'ml_stock',code;i+=1
        code_rt_dt = realtime_data.loc[int(code)]
        code_basic = basic_env.loc[int(code)]
        try:#code_rt_dt 有时候有重复数据，这里直接加载出来realtime
            # 文件没有去重，造成获得series 无法比较 ValueError
            if code_rt_dt['high'].item()==code_rt_dt['low'].item() and code_rt_dt['open'].item()==0 :#停牌
                print 'high_low_open==0';continue
            #codata = pd.read_csv(dtcst.My_Database_Dir+code+dtcst.Suffix)
            #data=ts.get_k_data(code);
            data = ts.pro_bar(util.x2Code(code),adj='qfq').iloc[::-1]
            print(data.tail())
            data.rename(columns={'vol':'volume','trade_date':'date'},inplace=True)
            codata = prep_d.preprocess_data(data, code_basic)
            codata.to_csv(dtcst.My_Database_Dir+code+dtcst.Suffix)
        except Exception,e:
            print e,'data get exception'
            continue
        if len(codata)<=25:
            print 'ml_all data amount too small'
            continue
        else :codata_basic_code_mapping[code]=(codata,code_basic);
        advice = True;
        additional = additional_judge(codata,code_basic,code_rt_dt)
        Coefficient_of_Variation = after_big_drop_positive_residual_propotion(codata)     #这里计算名和Coefficient_of_Variation不一样因为recommend代码里面固定了。
        column_generated(codata,compute_f=after_big_drop_positive_residual_propotion,
                         start=max(len(codata)-codata.iloc[-1]["dist2last_big_drop"],0))
        info=str(Coefficient_of_Variation)+'————代码：'+code+'——成交额：'+str(codata.iloc[-1]['amount']/(1.0*10**8))[:4];
        predict_table.loc[code] = [code_rt_dt['name'],advice,info,additional,Coefficient_of_Variation]
        print(code,"is over.")
    util.code_func_map(code_func_map)#写回可能更新后的code_func_map
    predict_table.dropna(inplace=True)
    predict_table.to_csv(dtcst.My_Store_Dir+'predict_table.csv')
    recommend_table = recommend_table_generator(predict_table,codata_basic_code_mapping=codata_basic_code_mapping);
    recommend_table.to_csv(dtcst.My_Store_Dir+'recommend_table.csv')

def macd_diff_judge(codata):
    #判断macd一阶导数大于0  =  并且_MACD_or_MACD二阶导数_or_DIFF一阶导_大于0  = True
    last_data = codata.tail(1)
    #判断macd一阶导数大于0:
    firstD = (last_data['MACD_d'].item()>0)

    # 并且_MACD_or_MACD二阶导数_or_DIFF一阶导_大于0:
    item2 = (last_data['MACD'].item()>0 or last_data['MACD_d_d'].item()>0 or last_data['DIFF_d'].item()>0)

    result = firstD  and  item2
    return result

def default_fun(codata):
    # 默认的策略
    if after_big_drop_positive_residual_propotion(codata)>0.90:
        ll = codata.iloc[-1]
        if ll["MACD_d"]>=0:
            if ll["volume_d"]<0 or ll["backward_inference_MACD_hit"]<0:
                result = False
            else:result =True
        else:
            if ll["backward_inference_MACD_hit"]>0:
                result = True
            else:result = False
    else:result = False
    return result

def kdj_ema_quick_d(codata):
    last_data = codata.tail(1)
    #KDJ中D和K的一阶导数都大于零，J过于灵敏
    return  last_data['D_d'].item()>0 and last_data['K_d'].item()>0

def hmm_state(codata):
    # 隐马尔可夫筛选
    #print 'entering hmm_state(codata)',
    import hmm_predict as hmm_p
    codata=codata.tail(65)
    if len(codata)<25:return False
    state,_ = hmm_p.get_last_state(codata)
    return state

def ml_svm_predict(codata):
    import ml_svm as svm
    codata=codata.tail(65)
    #支持向量机SVM模型
    #print 'entering ml_svm_predict',
    if len(codata)<25:return False
    return svm.SVM_SVR_predict(codata)

def naive_bayes(codata):
    import Naive_Bayes_With_continuous_feature as nv_bys
    # 贝叶斯筛选
    codata=codata.tail(65)
    #print 'entering naive_bayes',
    if len(codata)<25:return False;
    #可以很好偷懒慎用
    #if codata.tail(1)['ema5_d'].item()<0:return False
    # 训练数据,标签
    #Drop rows by index
    castrate_data = codata.drop([codata.index[len(codata)-1]])
    trainData, labels = nv_bys.getTrainSet(castrate_data)
    features,_ = nv_bys.getTrainSet(codata.tail(1))
    #print '-',type(features),features
    # 该特征应属于哪一类
    result = nv_bys.classify(trainData, labels, features[0])
    #print features,'属于',result  
    return  not '-' in result

def quantity_potiential_judge(codata):#量能判断
    lastdata = codata.tail(1)
    # 换手率和成交额大于一定值
    turnoverrate_and_amount  =  lastdata['turnover_rate'].item()>mlcst.Turn_Over_rate_thresh and lastdata['amount'].item()>mlcst.Amount_thresh
    #流通市值大于一定值
    nmc_bigger       =  lastdata['nmc'].item()>mlcst.nmc_thresh
    # 近7日涨跌幅度不要太大
    last_n_days_p_change    =   abs(util.getlast_n_days_p_change(codata=codata,code='None',n=7,end=0))<mlcst.last7days_p_change_thresh

    result = turnoverrate_and_amount  and  nmc_bigger  and  last_n_days_p_change
    return result

def env_relative_judge(codata):
    #大盘环境用sh指的MACD_d值来预估
    lastdata = codata.tail(1);
    lastdate = lastdata['date']
    env_sh_data = util.get_codata(dtcst.My_Store_Dir,'sh');
    try:
        MACD_d = env_sh_data.loc[lastdate]['MACD_d'].item()
    except:
        print 'env_relative_judg env_sh_data key MACD_d error'
        MACD_d = 0
    return MACD_d>0

def damped_vibration_fitting(codata):
    # 阻尼振动股价拟合
    #print 'entering damped_vibration_fitting:',
    import Damped_Vibration_Fitting as D_V_F;d_num=40
    if codata.tail(1)['ema5_d'].item()<0:return False
    close = codata.tail(d_num)['close'].tolist()
    c_mean = sum(close)/len(close)
    close=[c- c_mean for c in close]
    X = range(d_num)
    _d,plt = D_V_F.damped_vibration_equation_fitting(X,close)
    try:
        plt.show()
    except: pass
    del plt
    return _d>0

def discrete_F_T_predict_fitting(codata):
    # 离散傅里叶分析 预测拟合
    #print 'entering discrete_F_T_predict_fitting:',
    import DFT ;d_num=55
    if codata.tail(1)['ema5_d'].item()<0:return False
    close = codata.tail(d_num)['close'].tolist()
    c_mean = sum(close)/len(close)
    close=[c- c_mean for c in close]
    _d,plt = DFT.discrete_F_T_predict(close)
    try:
        plt.show()
    except: pass
    del plt
    return _d>0

def temp_test(codata):
    #策略测试
    pass

def Most_Optimized_Curve_fitting(codata):
    #选用最优的拟合曲线来预测
    return getCoefficient_of_Variation(codata)>0.55;
    import Optimized_Curve_fitting as OCF
    if len(codata)%10==0:print len(codata)
    return OCF.get_Optimized_Curver_fitting_func(codata['close'].values)

def additional_judge(codata,code_basic,code_rt_dt):
    # 自己选股的附加限制避免推荐过多无法选择
    # 东北企业筛选限制
    def isnortheast(code_basic):
        return not code_basic['area'] == '黑龙江' and not code_basic['area'] == '吉林' and not code_basic['area'] == '辽宁'
    # ST带帽股票不要
    def isst_stock(code_rt_dt):
        return not 'ST' in code_rt_dt['name']
    return isnortheast(code_basic) and isst_stock(code_rt_dt)

def last_believe(codata,input_s=''):
    """用于前面周期的强度判断"""
    #具体选择的指标及最近一个周期的极点数据  =  计算最近一个周期LastBelieve值  =  \
    compute_multiperiods_like_the_previous  = True

    """具体选择的指标及最近一个周期的极点数据:"""
    # ::::::::::::::::::::::::'':::::::::::::::'''''':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::':':::::'''''::'::::::':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::!|%%%%%%%%%
    # ::::::::::::::::::::::::::::::::::::::::::'':::::::::'::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''''':::::::''::::''':::'':''''''':::::''''''''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;!|%%%%%%%|
    # ::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::'::::::'::::::'':::::::::'':::::::'''::::::':::::::'''''''''''''''''''''''''''::':::::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::;!|%%%%%%%%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''::::::'::'':::::::::::'::::::::::::'''''''''''::'''''''':''''''''''''''''''::''''':::::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::!|%%%%%$$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::'''':::::::::::::::::''':''''::::''::'':::'''''''':''''''''''''::'''''':'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::;|%%%$$$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::'''::::::::'':::::::::''::::::''::'''''''::::''::::::''''':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::;!|%%$$$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::''''::::::::::::::::::::::''::::''':''''''''''':::::::::::::'''''''''::''':::'''''''''''''''':''''''::'''':'''''''''''''''''''''''''''''::':'''''::'''''''''''''''::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::;!|%%$$$$%
    # ::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::''''':::::::':::::::''''':::::::'::::'':::'':::''''::'''''''':::::'':':::'':''''''''''''''::'::':'''''''''''''''''''''''':''::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''::''':::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':;|$$|;''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::!|%%$$$$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::''::::':::::::::':''''::::'''''''::::::::':::'''':'''''''''':'''''''''''''''''''''''''''''''''''''::'':':::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''';%$$|;:'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::;|%%$$$$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::::::::::::::::::''''':::::::::::::::::::::::::::''::::::::'::'''''''''':'':::::''::'''':'''''''''''''''''''''''':'''''':''''':::'''''''''''''''':::''''''''''''''''''''''''''''''::''''::''':'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':|%$$|::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'':;!%%$$$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::'':::''''':::::::::::::::::::::::::::::'::::'':::''''''''''''''::::::::::''::::'''''''''''''''''''''''''''''''''''''':'''''''''::'':'''''''''''''''''''''''''''''''''''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':!||;:''''':;;;::'''''';|$$%!:''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::'::!|%%$$$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::'::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':''''':::::::::'::::!%|;'''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'''''''''''''::''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::'''''''''''''''':;!%$$$|;:'''':!%%$$$|;;:::!%$$%;:''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'::;|%%$$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::'':::::::::'''''::'::::::::::::''''''::::::::::::'::'::::::::::::::!%$|;:''''''::::'':'''''''''''''''''''''':'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':;;:::':'''''''''''''''''''''''''''''''''::''''''''''''''''''''''''':;!!::''':;|%$$|;:''''''''''';|$$$$$$$$$%;:''''':;|%$$$%|!%$$$%;:''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'::;!%%$$$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':':::::::::::::::::'::::::'::''':''':'''::::::::::::''''':::::::::::::''::::'::::::::;|$%!::::::'':::::'':'''''''''''''''::''''''''''''''':''::::::::'''''''''''''''''':::''''':::''''''''''''''''':::''':!$$$$$$$$|;:'''''''''''''''''''''''''':::;;;;!;::::''''':;!!|||!;:'':|$$$$$%!:;|$$$$$$%;:'''''''';|$$$$%%%!|$$$%;:'''''''':!%$$$$&$%!::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::!|%$$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::'''''':::::::::::::::::''''::::::::|$$|;::::'':'::::::'':::''''''''''''''::'''''''''''''::::!%$$$|:::'''::'''''''''''::'''':'''''':'':''::'''''::''::::|$$%|!|%$$$!:''''::'''''''''''''::!%$%%$$$$$$$$$$$$$%!:::!%$$$$$$$$||%$$!;|$$%|%$$|::|$$%;:'''''':!$$$%!:::!$$$$$|::'''''''''':;%$$$$$$$%$%!;::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::::;|%$$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::'::'''':::::::::::::::::::'''::':'::::::::::::::::::::''''::::::;|$$|:::::'''::::''':::::'':::'''''''''''''''''::'':'::::;|$$$$|;:'''''':::'''''''''''''''''::''''::''''::''''''''':;|$%!:'':::::''';%$%!:::::;!;:::'':!$$$$$%|!!!!!||%%$$$%;:''::':;%$$$$$$|::;|$$$$$|;:':|$$|:''''':;%$$%!::;|$$$$$$$|:'''''''''':!%$$$%%$$$$$$$|;::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::;|%%$$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::::::::::::::::::::::''::'':''''':::'''::::::'''::::::::::;|$%!:::::'''''''':''':::'::::''::'''''::''''''''''''':'::!%$$$!:::::::'':::''''':::::'''''''::::::::::''''::''':::::::::::::'''''''';%$$%!|$$$$$$$|;::::;!;::''''''''';%$$%;:''''''':!%$$$$|::;%$$$$%;:''';%$$|:'''''!%$$%;:!%$$%|%$$%!::'''''''':!%$$$!:::;!|%%%$$|;''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::!|%$$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::'''''':::::::::!$$%!:::'::::::'''''::''::'''::::'':::::::''::::''''''::::;%$$$!:::::::'''''''':'''''''':'':;!%$$$|;:::''::''::':::::::'':::::::::'''::|$$$$$$|!|%$$%;::'''''''''''''':!$$%;:'''''''':!%$&$|:':!$$$$$!::''':;%$$!:''';|$$$|!%$$$|::!%$$%;:''''''':|$$$%!:'''''''::;::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;|%%$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::::::::::::::::::::::::::''':::::::::::::'':::::::::::;|$%!::::::::::'''''::::::::'::::::::''::':::;::::::::':::|$$$|;:;!!;;::''''::'''''''''::::;%$$$$$$$!::''::::::!%$$$$!:::::|$$$%;::''':;%$$&%;:::;%$$%;:''''''''''''':|$$$!:''''''':::|$$$%;:':!$$$$|::''''':!%$$!:'':!%$$$$$$%;::':;|$$$!:::''';%$$%!:'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;|%%$%
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::;%$$!:::::::::::'''::::::::::::''::''':::::;%$$%;::::::::;%$$%!;|$$&&$!:''''''''''''''''''':::::;%$$$!::;%$%||$$$$%$$$|::::!%$$$|;::'::;%$$$|:::':|$$$%;::'''''''''':!$$$!:''''':::::!%$$%!:::;|$$$|;'''''''';%$$$%;:'';|%$%!;:'''''':!%$$&&%;:!%$$%;:'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::::!%%$%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::'::::''::::::;%$$|::::::::::::''::::::::::::''''''::::!%$$$$!:::::::::!$$$$$$$$&&$!:::::::::::''':::'':::'''::;|$$$||$$$$$$&$|;:|$$&%;::::!$$%;:::::!$$$$|::''':|$$$%!::'''''''':!$$$!:::;!%$$$$!;|$$$|;:''::!!:'''''''''''!%$$$%;:'''''''''''''''':;%$$$|;|$$$|;:''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;|%%%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::;%$$|;:::::::::::::::;|%$%|;:;!!;:::::::!%$$$|;:::::::::!$&&&$$$%|!;:::::::::::'''''':::::::::::::;%$&&$$$|%$&$%;:::|$$$|::::!$$$|:::::!$$$$!::'::::!%$$$%!::''''':!%$$%%%$$$$$$$%|;!%$$%!:''''''''''''''''''':;|$$$|:''''''''''''''''''':::;|$$$|::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'::;!%%%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$$!::::::''::::::!%$$&&$%!;%$$%;::::;|$$$$|;::::::;!|%$$$$$!:::::::::''::::::''''':::''':::::::::!%$&&$|!%$&&%;:::!$$$|::::!$$$!:::::!$$$$|::::::::;%$$$&%;''''';|$$$$$$$$$%!;::':!$$%;:'''''''''''''''''''''';!!::''''''''''''''''''''':;|$$$$|:'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::!|%%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$%!:::::::'::::;|$$$$$$$|;!$&$|::::;%$$$%;:::::::;|$$$$$$$!::::::::':::'':::::::::'::::::::::::::;%$$&%;!$&&&|;:::!$$$%;:;%$$$$!:''::!$$%|;::::'':'':|$%!:::::':|$$$$%|!;:''''''''':::''''''''''''':''''''''''''''''''''''''''''''''';%$$$$$%!::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::;|%%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$!:::::::::::;|$$$%|%$|;!%&$$!::::!$$$$%|;;::::::|$$%%$$$!:::::::::::::':::::::::'':::::::::::::!%$$$|;!$&&$|::::;%$$$|;|$&$$|::::::::::::::::''':'':::''::'''::;;::::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':!!||!::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'::;|%%
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$%;::::::::::;|$$%!::::::;%$$%!:::::;%$$$&&&$$%|;::::;|$$$!:::::::::::::::::::::::'''':::::::::::!$&$$!:;%$|;:::::;%$$$$!;!!;::'''''''::::::::''''''':'''''''''''''''::'':'''''''''''''''''::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::;!%|
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$$$|;:::::::::|$$$!::::::;%&&$$!::::::::;!||%$$$$&$%!::|$$$|::::::::::::::::::::'::::::::;%&$!::::|$$$%;:::::::::::!$$$$!:::':::''''''::':'::::''::''''''''''''''''''''''''''''''''''''::''::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;||
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$|:::::::::|$$%!::::::!%&$$&&$|:::::::::::::::|$$$%;:!$$$%!::::::::::::::::::::::::::;|$&&$!:::;%&&$|:::::::::::::;!;::::::'::':::::::'':::::::'''':'''''''''''''''''''''''''''''''':'::'''':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::;||
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$%!::::::::!$$$%;::::;|$$%||$$$$!:::::::::::::!%$$|;::;|$$$|;::|$$|:::::::::;!|%%$$$$$$$$&%;::::;%&&$!::'''''::::::::'''::::::::::::::::::'':::''':::::'::''':'''''::'''''''''''''''''''''''':::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;!|
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::::::::::::::::::::::::::!$$$|;:::::::|$$$$%;;!|$$$|;::;%&&$!:::::::::::!$$$|;::::|$$$%!:|$&$|::::::!%$&&&&$$$$$$%|;:::::::!%$%;::::::::'::::::::::::::::::::''::':':':::::::::'':::'''''''''''''''''''''''''''''''''''''''''''''':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::;;::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::::;!
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$%;:::::::!%$$&&&&&&&$|;:::;%$&&$|::::::::;|$$%!::::::!$$$$&&&&$|::::::|$$$$$$%|;;:::::::::::::::::::::':::::::::::::::'::::::::::::::::'::::::::::::''''''''''::''''''''''''''''''''''''::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::::::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':'::;!
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&&$$$|;:::::;%$$$&$%!;:::::::!%$|;::::!$$%%$$|;::::::::;|$$$&$|:::::::!$$&&$$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''''''::::'''''::::''''''''''''''''::''''''''''::::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::::::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::;!
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&$|;::::::::::::::::::::::::;:::::;|$&$$%;:::::::::::::;;;:::::::::;%%!:::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::''''':::::::::::::::::'''::'':''''':''''''::::::::''''''''''''''''''''''''''''''''''''''''''''''''''''':'''''':::::::'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|%$%%|;:::::::::::::::::::::::::::::::::!|!;::::::::::::::::::::::::::::::::::::::::::::::::::::':::::':::::::::':::::::::::::::::::::::::::::::::::::::::''::''::::::''':::::''::::''''''''''''':':::'''''''''''''''''''''''''''''''''''''''''':'''''''''''''''''''''::::'':''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::'''':::::::::''':::::::::::':::'':::'''''::'''::'''::::::'''''':'''''''''''''''''''''':'''''''''''''''''''''''''''''''''''''''''''''''''''''''''':;::::'''''''''''''''''''''''''''''''''':''''''''''''''''''''''''''''''''::::;
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''''''':'''''''::::':::::::::::::'''''''''':::::'''''''''''''''''''''::''''''''''''''''''''''''''''''''''''''''''':::::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::::;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::':::''''::::::::::::'':''''''''''''''::'''':::::::''::'''''''''''''''''''''''''''''''':''''''''''''''''''''''''':''':'''''''''''''::''''''''''::''::''''''''''''''''''''''''''''''''::::;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::'':::''''':::::::::':::::::::::::':'''::'''::::::::::::::::::::''::::::'''''''''''::':::::''''''''''''''''''''''::::'''''''''''''''::'''''''''''''::'''''''''::::''''''':'''''''''''''''''''''''''''''''''''''''''::::;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::'''::::::'''::::::::::::::'''''''::::'''''''''''''''''''''''''''''''''''':::''''''':''''''''''''::'''''''''''::::''':'''':''''''':::''''''::'''''''''''''''''''''''''''''''''::::;
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::'':::::::''':::::::::::'::::':'''''::::::::':'''''''':'''''''''''''''':''''''::'::'''''''''''::::::'''''''':::''::'''''':::'''''''''''''''''''''':'''''''''''''''''''''''''''':'''''''''''''''::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|$&&&&&&&&&|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::':::::::::::::::::::::::::::::'':::':::::::::::::''::::''''''::'''''''::'':::'''''':::'''''''''':''''''''''''''''''''':::'''''''':''''''''''''''''''''''''''''''''''''''''''''''''''''''''':::''''::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!$&@@&@@@@@@&$&&&@@@@&&&$%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::':::::::::::::::::::::::::::::::::::::'::::::::::::'':::::'''':::::::'''::::::::::::'''''''''':::::''''''''''''''''':'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::':'::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!|%$$&@@@@@@@@@@@@@&&@@@@@@@@@@@@&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::''''::::::::::::::::::::::::::::::::::::'''''':::'''''::::::::::::::::''''''''::::''''''''''''''''''''''''''''''''''''''''':'''''''::'''''''''''''''''''''''''''''''''''''''''''''''::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!|$&@@@@@@@@@@@@@@@@@@@&&$%%%%$&&&&&&&&&&&&&%!!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::'::::'::::::::':::::::::::''''':::::::::::::::'''''''''::'':::::::::'''::::::::'''':'::'''':::''''''''''''''''''''''''''''''::'''''''''''''''':::::''''''''':'''''''''''''''':'':''''':::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%&@@&&&&&&&$$$&&@@&&@@&@&%!:::::::::;;!|%$&&&&&&&&&&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::::':::::::::::::'::::::'''':::''::'''':::::::::'':::'''''''''''''''''''''''''''''''':''''''''''''''''''''''''''''::''':::''''''''''''''''''''''''''':::':::;
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%&&&&&&$$$$$%!;;::::|$&&&&&&&%;:::::::::::::::'::':!%$&&&&&&&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::':'':::::::::::::''''::::'''':::'''':''''''''''''''''''''''''''''::'''''''''''''''''''''''''::'''''''''''''''''':''''''''':''''''''''':::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$&&&@&&&&&%!;:::::::::::|$$&&&&$!::::::::'::::::''''':'''':!%&&&&@&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::'''::::::::::::::::::::::::::::::::':::'::::::::::::::::''::::::::''''::''''''''''''':::::''::''''''''''''''''::''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''::;
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&@&&&&&$|;:::::::'::::::;|$&&&&&$|:::::::::::::::::::'':''::'':!$&&&&&&$!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::::''::::':::::::::''''''':::::'':::''''''''''':::::::'::::::''::::::::''''''''''''''''''''''''''''''''''''''''''''::'''''''''''''::'''::;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&&&$|;::::''':::::::::::!$$&&&&$%!::::::'':::::::::::::::''':''':;!%$&&&&&%;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::''''::::::::::'''''''':::::''''''''''''':''::::::':::::::'''::'''''':::'''::::'''''''::''''''''''''''''::::''''''''''''''''''''':;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&&&&%!;:::::'':::::::::::::;|$&$%!;::::::::::::::::::::::::::''''''''':;|$&&&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''::::::::::::''':::::'''::::::::::::::::::::::::::'''''''''''':'''''''''''::'''''':::'''''':::::':::''''''::''':::'''''''''''''':'''''':'::''''''''':;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&&&$!::::::::::::::::::::::::::;;:::::::::::::::::::::::::'':''''::::'''''::!%&&&&&&$!:::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::'':::::''::::::::::'':'''''':::::::'''':''':'::''''''''''''''''::''''''''''''''''''':::::''''''''''''::''''''''''''''':::''''''''''':;
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::'::''':::;|&&&&&&%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::''::::::::::::::::::'':::::::'':::::'''':'''''':::::::::'''''''''''::'':'''''::::::'''''''''''''''''''''::'''''''''''''''''''''''''''''''''''''''''''::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&$|;:::::::::':::::'::::::::::::::::::::::::::::::::'::::::::::::::::::::::''''''::;|$&&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::'':::::::''::::::::::'::::::::::::''':''''''''':''::::::''':::''':::''''''''''''''::'''''''''''''''''''''::''''::'''''''''''''''':''''':
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$|;::::::::::::::::::::::::::::::::::::::::::::::::'''':::::''::'::''::''''::''''''':;!%$&&&&&|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::'::::::::'''::::::::''''''''''''::'''':::::::''''''''''::'''''''::'''''''''''''''''''''':'':'''''''''''''''''''''''''''''::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&$|::::::::::::::::'::::::::::::::::::::::::::::::::::::::::'''':::::::::::'::::'''''''::::|&&&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::'::::::::''::::::::::::::::::''''''''''::':::'':::::::::'''''''':::::'''''''''''':''''':''''''''''''''':''''''''''''''':'''''''':''':''''::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&%;::::::::::::::::''::::::'':::::::::::::::::'::::::::::''::'::::''::::::'''''::::'''''''::';%&&&&&&&|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::'''''''''''''':'':::'':'':::'''''''''''':::'''''''''''':''':::''''''''''''':''''''''''':::''''''''''''''''::'''':
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':''::::::::::::::'::::::::''''''':%&&$$&&&&|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::'::::''''''''':::''''''''''''''''''''''::'::''::::'''''':::::::::::'''''::'''::''''''':'''''''''''':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::::''''::::::::'''''':::!%&&&&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::''':::::::''::::::''''''::::''::''':::''''''':::::::'''::'''''''''''''::::'''''''''''':''':::::'''''''''''''':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::'''''''::;!%$$&&&&|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::::::::::::':::''''''''''':::''''''''''''''''''''''''''''''':'''''''''''''''''':::'::::::''''''''':':::':'''''::''''':::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&%!:::::::::::::::::::::::::::::::::::::::::::::::::''::::':::::::::::::::::::::::::::::::':::''::''''''''!$&&&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''::':::::::::':::::::::'''''''':::::::''::::::''''''::'::''''''''''''':':::::''''''':'::::::::'''''':::'''':::::::::'''''':::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::'::::::::::::::'''::::::'':''''''':!$$$&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''''''''''':::::::::::::::''::::::::::::'':''''''''::::::':::''''''''''''''''':::::'''::::''':::::::'''':::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''''::::::::::::::''''':;|&$&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::':::'''''''::'''::':::::::''':::::::''''''''':::::::'''':::::':''::':::'''''''''''''':'''':''::::::::'':::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''''::::::::'''':::::''':!$$$$&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''''':::::::::'::::::''::::':::::::'''''::::::::::::::::::::::::::::''''''''''''''''':::'::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&$!:::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::':'''''''':;%$$&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::':::::::'''''::::''''::::::::::::::::::::::::::::::::''''''''':::':::::::::'''::':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|$&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''''''''::!$$&&&$;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::::::::::::::::::''::''::::''''''::::::::''::'::'''::::::::::::::::::::::::::::::::''::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::'''':::::'':;%$$&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::'::::::::::::::::::::::::::::'::::::::::''''::::''':::''::::::::''::::::::::::::::::::::''::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::::::::::|$$$&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::::'''::::::::::::::':::::::::::::::::::::::''''''''':''''::::::::'''':::'':::'''''''':::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::'''':'':::::::::::::::::|$$$&&&|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::'':::'':::':::::'''''':::::::::::::::::::':::::::'':::::::::''''':::::::::::'':::::':''''''':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::;|$$&&&|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''''':::::::''':::''::''''':'''''''''''::'''::::::''':'''':':::::::''::'':::::::'':::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''::::!$$$&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''''::::::::''''':'':::''::::'''''''::::::::::::''::::::'':::'''''''':::::::::::':':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::;%$$$&$|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::'''::::'':::''::::::::::::::''''''':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|$&&&%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::'::::::::::'''''::::::!%$$&&|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::'::::::::::''':'''::::::::::''':::::::::::'''''''''''':::'':'''''':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!$&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::;%$&&&|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::''''''::'''':::'':::::''::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::'':::::!$$&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':'''::''':::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::!%$$&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::'::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::;%&&&&$|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''':::::':::::::''''::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::|$&&&&$!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::::::''':''''''':::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|$&&&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':'':::::::::::::::'::::::::::::::':
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::'::::::':::::::::::!$&&&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::'::::::::'::::::::::::::::::::::!%&&&&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::'::':::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::':::::!$&&&&&|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''''':
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&$|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::'::::::::::::':::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&$|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&$&&$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'''::::::::::::::::::::'::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|$&&&&$!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$$&&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::''::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::;|$$&&&&|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$$&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&$|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%$&&&&%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|&@&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&@&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&&|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&@&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;|||!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&$|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$$&&&&&&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&@&&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&&%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|%$&&$&&&&&&$%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;|$&&&&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&&&$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!|%$$$$$&&&&&$%|;;::::::::::::::::::::::::::::::;!|%|!;::::::::::::::::::::;!|$&&&&&&&&%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!$&&&&&$%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%$$$$&&&&&&$|!;:::;;;:::::::::::::::::::!%$&&&&&%!;:::::::::::::;|%$&&&&&&&&&&%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&$%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::::::::::::::::::::::::::::::::'::::::::;|%$&$&$&&&&&&&&$|;;:;;;;::::::::::::;|%&&&&&&&&$!;;;;;:;;!|%$$$&&@&&&&&&$%!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%&&&&&$%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::;;!|$$$$$&&&&&&&&&&&&&$$$&&$$$$$$&@@@@@@&&&&&&$$&&&&&&&&@@&&&&&&&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!|||!:::::::::;|$&&&&&$%!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%$&&&$&&$$&&&&&&&&&&&&&&&@@@@@@@@@@@@&&&@@&&&&&&&&&&&&&$|;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;::::::::::::::::::::::::::::;|&&&&$%!;::::;!%$&&&&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;!|%$%$$&&&&&&&&&&&&&&&&&@@@@@@@@&&&&&&&&&$$$&$%|!;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;|&&&@@&&$!::;!$&&&&&&&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;!!!!!|$&&&&@@@&&&$|!;;;;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|&&&&&&&&$!!%&&&&&&&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&&&&&&&$!::::::::::''''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;::::::::::::::::::::::::::::::::::::;|$&@@@@@&&&&&&&&&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&&$%!:::::::'''''''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$$$$|!!;;:::::::::::::::::::::::::::!%&&@@@@@@@@&&&&&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$$$$$|;::::::::::::::'::::''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;!%&&&&&&&&&$$%%%|!;::::::::::::::::::;|$&@@@@@@@@@@@&&&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!!!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%&&&&&&&&&@@&&&&&$$$%%%|!!!!!!!!||!!%&@@@@@@@@@@@@&&&$|;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;!!%$$&&&&&&&&&&&&&&&&&&&&&&&&&&&@@@@@@@@@@@@@@&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::::::::::::::::::::::::::::::'':::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;!!|%$$&&&&&&&&&&&&&&&&&&&&@@@@@@@@@@@&&$|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;!|%%$$%%%$$$%|%$&&&@@@@@@@@@&&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!$&&&@@@@@@@@@&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$|;:::::::::::::::::::::::::::::::::::::::'':::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&&&&@@@@@@@@&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$$$|;::::::::::::::::::::::::::::::::':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&&&@@@@&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&&&&&&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$&&&&&&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$%;::::::::::::::::::::::::::'':::::::''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;::::::::::::::::::::::''::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&&$%!!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%&&$|;::::::::::::::::::::::::::::::::':::::::::::::::::::::::'''':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!!|$$&$|;:::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!$&&&&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&$!;:::::::::::::::::::::::::::::::::'''::::::::::::::::::::::''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&&&$!:::::::::::::::::::::::::::
    # :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!$&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&$!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::''::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%$%|!!;;:::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&&%!::::::::::::::::::::::::::::::::::::::::::::::::::!||;::::::::::::':::::::::'':::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|%%!;::::::::::::
    # ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$&$|;::::::::::::::::::::::::::::::::::::::::::':::::::!$$$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|%$$$%!;:::::;|$$&$!;:;!|%%%!;::
    # ::::::::::::::::::;;!!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$|;:::::::::::::::::::::::::::::::::::::::::::::::::;%$$$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$$$&&%!::::;|$$&&$|%$$$&&&$$|;
    # ::::::::::::::::;|$$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::!%&&%!:::::::::::::::::::::::':::::::::::::::::::::::::::::::;|$$$%$%|!;;!|%$$%!;;:::;|%||$&&$|;::::;!%$&&&&&&$%%$$$%!
    # ::::::::::::::;;%$$%!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$&&&$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$!;:::::::::::::::::::::::::::::::::::::::::::::::::!%$$|;:::;!|||!;:::::::::::::::::::::::::::::;|%$$$|;:::::::!%$&&&&&&&$$$$&&&&&&&%!::::::;!$&$|;::::::!%&&&&&$|;;!%$$|
    # :::::::::::::;;!%$$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&&&&&&$!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&%!::::::::::::::::::::::::::::::::::::::;!||!::::::;|$$$|;;|%$&&&&$!:::::::::::::::::::::::::::::!%&&&&&%;:::::!%$&$%!!!%$&&&&&&&&&&&&%!;:::::!%$&$|;:::::;|$&&$%!:::;|$&%
    # :::::::::::::;;!%$$%!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!||!!$&&$|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$&%;::::::::::::::::::::::::::::::::::::;|$$$%!;:::::;|$&$$$&&&&&&$%|;:::::::::::::::::::::::::::::;%$&&&&&%!;::!%&&$!;:::;%$&&&$!;!%$&&&$%!::::;%$&&%!:::::!%$&&%!;:::;|$&%
    # :::::::::::::;;!%$|!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;|||!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$$$%;::::::::::::::::::;|||!;::::::::::;|%$&&$|;:::::;!%&&&&&&$$$$$%!:::::::::::::::::::::::::::::::;|$&&&&&&&$!!%$&$|;::::;|$&&&%;::;|$&&%!;:::::!%&&$!;:::;|$$$$%;:::::!%$%
    # :::::::::::::;;!%%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$$|;:::::::::::::::;!%$&&$$$$|;::::::!%$$&$|;;::;!%$&&&&&&$|!;::::::::::::::::::::::::::::::::::::::;|$&&&&&&&&$$&$|;:::::;|$&&$|;::;!%&&&$|;::::;%$&$|;:::;|$&&&%!:::::!%$%
    # :::::::::::::;;|%%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!||!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!|!;:::::::::::::::::::::::;!||!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%$$%;::::::::::::;|$$&&&%||$&&%!:::::;|$$$$|;:;!%$$&&&&&&&$|;::::::::::::::::::::::::::::::::::::::::::;||$&&&&&&&&%!:::::::;%&&&%;:::!%$&&$|;::::!%$$$|;:::;|$&&&%!;::::;|$%
    # ::::::::::::;;!%%|;::::::::::::::::::::::::::::::::::::::::::::::::::::::;!%$$$%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%&&$!::::::;;;;;;;::::::::::!$&&&$!;;;!;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$|;:::::::::::;%$$$%|!;;|$&&$|;:::;|$$&%!;::;|$$&$%||%$&$|;:::::::::::::::::::::::::::::::::::::::::::::;|$&&&&&$|;:::::::!$&&$%;:::;|$&&$!;::::;|$$&%!:::;|$&&&%!;::::;|$%
    # ::::::::::::;;!|%!;:::::::::::::::::::::::::::::::::::::::::::::::::::::;;|$&&$$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;::;;;|$&$|;:::;!|%$&&&$%|;;::::::;!%&&&&%|$&&&$!;;|%%|!;;:::::;!|!!!%$$%!;;:;|$$$$$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$|;:::::::::;|%$$%!;::::;%$&$%;:::;%$$$|;::::!%%%|;:!%$&$|;:::::::::::::::::::::::::::::::::::::::::::::::!%&&&&$|;::::::;|$&&$%;::::!%$&$|;:::;!%$&&$!;::;|$&&&%!;:::::;|%
    # :::::::::::;;;|%|!::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$$$&$%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;!|!!|!!;:::::;!$&$%!;;;!$&&|;;;;|$&&&&&&&&&&$%!;::::;;|$&&&&&&&&&&$%$&&&&&$|;:::;|$&$%%$&&&&%!|$&&&&&&$%!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&$|;::::::::;!%$&%!;:::::!%$&&$|;::!%$$&$|!;::::::::;|$$&$|;:::::::!||!;:::::::::::::::::::::::::::::::::::;!%$&&$%!;::::::!%$&&%;::::;%$$$%!::;|$&&&&$|;:::!%$&&$%;::::::!|
    # ::::::::::;;;!|%|!:::::::::::::::;;:::::::::::::::::::::::::::::::::::::;;;|$&$|;::::::::::::::::::::::::::::::::;;;:::::::::::::::::;;;;::::::::;;|$&&&&&&$|;::::;!%&&&$%!|$&&%!;;!$&&&&$%|||$&&&$!;:::::;;%&&&&&&%%&&&&&&&&&&&%!:::;|$&$|!%&&&&&&&&&$%$&&&&%;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&&%!;::::::;|$&&$|;:::::;|$&&&&%!;::!|$&&&&$$%!;;:::;|$&&&$!::::::;!%&&%!;::::::::::::::::::::::::::::::::::;%$&&$|;:::::::;%$&&%!::::!%$$$|;::;|$&&&&&%;::::!%$$$|!:::::::;
    # ::::::::::;;;!%$|!::::::;;::::::::::::::;;::::::::::::::::::::::::::::::;;!%&&$|!;;;:::::::::::::::::::::::::;!%$$$%!;:::::::::::::;|%$$%!;:::::;|&&&&&&&&&&%!;;:::;;!%&&&&&&&|;;;!%&&&$|;;;;|$&&$|;;::::::;|$&&&&|!%&&&&&$||$&&%!;::;%&&$!;;!$&&&&&&$!;;|$&&%;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!$$$%!;::::::;%$&$|;:::::;!%$&&&&&$$$$|!!|%$&&&&&$$%|;;;%$&&$|;:::::!%$$%!;:::::::::::::::::::::::::::::::::::;!$&&&%;:::::::;|$&$|;::::;%$$%!:::::;|%$%!;::::::;!|;:::::::::;
    # :::::::::::;;|$%|;::::::;:::::::::::::::::::::::::::::::::::::::::::::::;;|$&$|;|$$$%|!;:::::::::::::::::::;;%&&&&&$$|;;;!%%%%|;:;|$&&&&$%!:::;!$&&&$|!|$&&&$|;;::;;;;;|$&&&&%!;;;;|%|!;;::;!$&&$!;:::::::;;|&&&&%!!%&&&&$!;|$&&$!;;;!%&&%;;;;|&&&&&$|;:;!%&&$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&%!::::::!$&&$%!;:::;!$&$%$&&&&&&&%!;::;;;!%$&&&&%!;!$&&&$!;::;|$&$|;:::::::::::::::::::::::;!|%$%%|!::::::!%&&&$!::::::::;||!:::::::;!!;::::::::::::::::::::::::::::::::;
    # ::::::::::;;!%$%!;:::::::::::::;;;;::::::::::::::::::::;;:::::::::::::::;|$&$|!|$&&&&$|;:::::::::::::::::::;;!%$$$&&$$|!$&&&&$$|%$&&%|%&&$!;;;|&&&$|;;;%&&&&&|;;::::::;!%&&&$!;;;;;;;;::::;!$&&%!;::::::::;!$&&&%!;|$&&&%!;!%&&&$!;:;!$&$|;;:;|$&&&$!;:::;%&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&$!::::::;|$$&&$%!;;|$&$|!!%&&&&&$|;:;!||!;;!%&&$|;:;!%$&&$%|%$&&$%;:::::::::::::::::::::::;!%&&&&&&%;:::::!%$&&$|;::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # ::::::::::;;|$$|;:::::::::::::;;;;;;;::::::::::::::;;!%%%|;:::::::::;;!|%&&&&&&&&&&&$!;:::::::::::::::::::::;;;;;|$&&&&&&&$&&&&&&&&|;;|$&$|;;!$&&$|;;;;%&&&&&%!:::::::;|&&&&&%!;;;;::::::;!$&&%!;:::::::::;|$&&$!;;|&&&$|;;!$&&&|;::;|&&&|;;:;|$&&&%!::::;!$&&&%;:::::::::::::::::::::::::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;|$&&&&$|;:::::;!%$$&&$$$&&$%;:;|$$&$|;;:;!%&$%||%$&$!;::::!%$&&&&&&&$|;::::::::::::;;;;!;;;!!|%$&&&&&&$!;::::::!%$&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::::::;;!%$%!;;:::;;;;;;;!|%$$%!;:::::::::::::;;;|$&$$|;:::;;;!|$$&&&&&&&&&&$%|||!;:::::::::::::::::::::::::;;!$&&&&&&|!|&&&&&&|;;;|$&$|!!%$&%!;::;!$&&&&&$|;::::;;%&&&$&&&$$$%!;::::;|$&&%;;;;;;;:::::!%&&&%;;!%&&&$!;;!%&&&%!;;!$&&$!;;;;|$&&$|;:::::;!$&&&%|!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;%$&&$!;::::::::;!%$$&&&&&%!;::;|%|;:::::;%$&&&&&$%!:::::::;!%$$&$$|;:::::::::;!%$$&&&&&&&&&&&&&&&&$$%!;:::::::;|$$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::;;;!%$%!;;:;;;;;:;|$&&&&$%!;;;;:::::::;;;;!$&&&%!;:::;|$&&&&&&&&&&$%!;;;;;;::::::::::::::::::::::::::::;;;|$&&&&%!;|$&&&&%!;;;!%&&$||$&$|;;;!%&&&&&&&&$|;;:;!%&&&%!|&&&&&$!;::;;!%&&%!;!|%$$%%|;;;|$&&$|;;|$&&&|;;;!$&&&$|;;!$&&$|;;;!%&&&$!;::::::;|$&&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::!%$%|;:::::::::::;!|%%|!;;;::::::::::::::;|$&$%!;:::::::::::::;;;:::::::::::;|$$&&&&&&&&&&&&$%|!;;:::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::;;!%$%|;;;;;;;;;%&&&&&$$$|!!%|;::::::;;;|$&&$%!;:::;!$&&&&$|!!%&&$|;::::::::::::::::::::::::::::::::::::;;!$&&&%!;;!$&&&&|;;;;!%&&$|%&&$|!!%&&&&&&$&&@&&$%||$&&%!;;!%&&&$|;:::;!%&&&&&&&&&&&&&&$|!%&&$|;;;!$&$|;;;!$&&&&%;;;!||!;;;;;%&&&$|!;::::::;;%&&&&%;::::::::::::::::::::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;:::::::::::::::::;;::::::::::::::::::::::::::::::;|$&$$||!!;;!!!;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::::;;|$$%!;;;;;;;|$&&&$|;;;;;|$$%!;::::;;|$&&&$|!;;::;!%&&$|;;;;!%&&%!;::::::::::::::::::::::::::::::::::::;;|&&&$|;;;!$&&&%!;:;;!$&&&$&&&&$&&&&$|!!!|$&&@@&&&&&&|;;:;;!||!;;::::!%&&&&&&&&&&&$&&&&%!|%|!;::;;;;;;:::;;!|%|;;::;;:;;:::;|$$|!;:::::::::;!%%|!;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :;;::::;;!%$$|;;;;;;!%&&&%!;;;;;;|$&$$|;:::;;|$&&&&&$$$%%|||$$$|;;;;;%&&$%!;::::::::::::::::::::::::::::::;;::::;;|&&&%!;;;!$&&$|;:::;!$&&&&&&&&&&&&|;;;::;;|$&&&&&&&$|;:::::::::::::;%&&&&&&$%|!;;;;!!;;;;;::::::::::::;::;;;;;::::::;;:::::;;;;:::::::::::::;;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # ;;;;:::;;!%$%!;;;;;;%&&$%!;;;;;;|$&&$$%!;:;;;!|%%%%$$$$$$&$%!;;;;;;;!%&&%!;;:::;;;:::::::::::::::::::;;;!%%%|!;:;!%&&&%!;;;!$&$|;::::;;!%|!!|%$&&&$!;::::::;;!||!!!!!;;::::::::::::;;%&&&&$%!;;;::::::::::;;::::::::::::::;:::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # ::::::;;;!%$%!;;;;!|$&&%!;;;;;;!%$%%$$%!;;;;;;;;;;;;;!!|$&$%|!;;;;;;|$&$%!;;;;;!%%|;::::::::::::::;;!|%$&&&&$|;;;|$&&%!::;;!||;;:::::::::::;;;;;;;;:::::::::::;;;::::::::::::::::::;;|$$!;;:::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :::::;;;;|$$|;;;;!|$&&$|;;;;;;|$$%!|$$%|;;:;;;;;::;;;;;!!|%$%!;:;;;;|$&$|;;;;;;%$$%!;::::::::;!!||%$&&&&&&&$|;::;%&&$|;:::;;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;:::::::;:::::::::::::::::::;;::::::::::;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::::;;;|$%|;;;;;!%&$$|;;;;;!%$%|!!%$$|;;:::;;;::;;;;;;;|$$%!;;;;;!$&&$|;;;;;%&&$|;::::;;;!%$&&&&&&&&$%|!!;;::;!%&$!;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # :::::;;;!%$%!;;;!!|%&$$|;;;|$&&%!;;!|$$%!!!!;;;;;;;||!;;|$&%!;;;;;;!|$&$$|!;!%&&$|!;::;;!%$&&&&&$$%|!;;::::::::;;;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :::::;;;|$$|;;!%%||$&&$$$&&&&$|;;;;;|$&&&$%!;;;;;;|$$|!|$&%!;;;;;;;;!|$&$$$&&&&$|;;;:;!%&&&&$%!;;;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;::::;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :::::;;!%$$|!|$$|!!|$&&&&&&$|;;;;;;;!|$&&$|;;;;;;;|%$$$$$%!;;;;::;;;;!|$&&&&&&$!;;;;;|$&&&&%;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :::::;;|$$$$$&$%!;;!|%%%%|!;;;::;;;;;;!!!;;;;;;;;!%&&&&$|;;;;;;;:::;;;;!%$$$%!;;:::;!%&&&$|;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;:::::::::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :::::;!|$&&&&&%!;;;;;;;;;:::::::::;;;::::;;:::;;;;|$&&%!;;;;;:::;;:::;;;;;;;;;;:::;;;;!|%|!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :;::;;!|$&&&$|;;;::::::::::::::::::::::::::::::;;;!!!;;;:::;::;;;;:::::::::;;:::::::::;;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;:::::::::;;;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::;:;;;|$&&%!;:::::::::::::::::::::::::::::::::;;;;;;;::::::;;:::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::;;;;!!;;:::::::::::::::::::::::::::::::::::::::::;;;;:::;::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # ::::;;;;;::::::::::::::::::::::;;::::::::::::::::::::;;::::::;;;;;;:::::::::::::;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    # :::::::;:::::::::::::::::::::;;;;;;::::::::::::::::::::::;::::;;::;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;
    p_change=input_s+'p_change';PVT=input_s+'PVT';VT=input_s+'VT';
    dist2last_min=input_s+'dist2last_min';dist2last_max=input_s+'dist2last_max';
    ll=codata.iloc[-1]      #最后一天的数据
    min_1_base=ll[dist2last_min]+1      #距离最近的一次极小值距离
    last_min = codata.iloc[-min(min_1_base,len(codata))]        #min_1_base 对应的数据

    min2max_index = (last_min[dist2last_max]+min_1_base)        #距离最近极小值的一次极大值距离
    last_min2max = codata.iloc[-min(min2max_index,len(codata))]     #min2max_index对应的数据

    max2min_index =(last_min2max[dist2last_min]+min2max_index)      #距离上述极大值的极小值的距离也即为倒数第二个极小值的距离
    last_max2min = codata.iloc[-min(max2min_index,len(codata))]     #max2min_index对应的数据
    #print last_min['stationary_info'];print last_min2max["stationary_info"];print last_min2min["stationary_info"]
    
    """计算最近一个周期LastBelieve值:"""
    #PVC：Price Volume （Trend） Change
    PVC_UP = last_min2max[PVT]-last_max2min[PVT]        #最近一个周期内上涨的PVT量
    PVC_Down = last_min2max[PVT]-last_min[PVT]          #下跌的
    VT_positive=last_min2max[VT]-last_max2min[VT]       #最近一个周期上涨时的成交量
    VT_negative= last_min2max[VT]-last_min[VT]          #下跌的
    #希望上涨的量比较大，同量纲的量用除法来除去量纲比较
    #Last指的是最近的一个周期，Believe指的是上涨量比去下跌量的比值，自然越大越好
    # 除法要考虑分子过小，因此用log函数重新映射一下
    LastBelieve = np.log(PVC_UP/PVC_Down*VT_positive/VT_negative)\
        if util.up20([PVC_Down,PVC_UP,VT_positive,VT_negative]) else 0;

    if compute_multiperiods_like_the_previous:
        Positive_net=Negative_net=0;VT_positive=VT_negative=0;
        min_periods_index=min_1_base; periods = 5
        for i in range(periods):
            try:
                min_periods_index = codata.iloc[-min_periods_index][dist2last_min]+min_periods_index
            except:
                min_periods_index=len(codata);break
        min_periods_index=min(min_periods_index,len(codata));

        for i in range(min_1_base,min_periods_index):
            temp=codata.iloc[-i];p_c=temp[p_change];vl=temp['volume'];pv=(p_c*vl);
            if temp[p_change]>0:
                Positive_net+=pv
                VT_positive+=vl
            else :
                Negative_net-=pv
                VT_negative+=vl
        HistBelieve=np.log(Positive_net/Negative_net*VT_positive/VT_negative)if util.up20([Positive_net,Negative_net,VT_positive,VT_negative]) else 0;
    
    Sythesis_Believe = 0.4*HistBelieve+0.6*LastBelieve  
    #print 'HistBelieve',HistBelieve,'LastBelieve',LastBelieve,'NowBelieve',NowBelieve,'unsaturated',unsaturated,'DaysBelieve',DaysBelieve
    return Sythesis_Believe
def combine_believe(codata,input_s=['','ema3_','ema5_','pseudo_mean_price_'],weight=[0.1,0.2,0.30,0.4]):
    return sum( [ tp[1]*last_believe(codata,tp[0])for tp in zip(input_s,weight)] );

def torque_factor(codata,input_s=''):
    """
    扭矩因子：用于判断前期几个周期的情况
    :param codata:
    :param input_s:具体用哪个价格指标
    :return:
    """

    p_change=input_s+'p_change';PVT=input_s+'PVT';dist2last_min=input_s+'dist2last_min';dist2last_max=input_s+'dist2last_max'
    ll=codata.iloc[-1];min_1_base=ll[dist2last_min]+1;
    Positive_net=Negative_net=0.0
    Positive_VT=Negative_VT=0.0

    #确定前面的周期索引
    min_periods_index=min_1_base; periods = 8
    for i in range(periods):
        try:
            min_periods_index = codata.iloc[-min_periods_index][dist2last_min]+min_periods_index
        except:
            min_periods_index=len(codata);break
    min_periods_index=min(min_periods_index,len(codata));

    #计算各个指标累计
    for i in range(min_1_base,min_periods_index):
        temp=codata.iloc[-i];p_c=temp[p_change];vl=temp['volume'];pv=(p_c*vl);
        if temp[p_change]>0:
            Positive_net    +=pv
            Positive_VT     +=vl
        else :
            Negative_net    -=pv
            Negative_VT     +=vl
    #扭矩因子 和前面的Believe 计算是一样的啊，用除法去掉量纲，而且也一样只对以往的周期进行了分析
    torque_factor_value=np.log(Positive_net/Negative_net*Positive_VT/Negative_VT)\
        if util.up20([Positive_net,Negative_net,Positive_VT,Negative_VT]) else 0;
    return torque_factor_value
def total_torque(codata,input_s=['','ema3_','ema5_','pseudo_mean_price_'],weight=[0.1,0.2,0.30,0.4]):
    assert sum(weight) == 1
    return sum( [ tp[1]*torque_factor(codata=codata, input_s=tp[0])for tp in zip(input_s,weight)] );

def jump_air_coefficient(codata,input_s=''):
    """

    :param codata:
    :param input_s:
    :return:
    """
    PVT=input_s+'PVT'
    label='close'

    #获取数据各个列的变化范围
    data_piece=codata.tail(75)[[PVT,label]]
    """Demo:
>>> data = pd.DataFrame([[1,2,3],[2,3,4]])
>>> data
   0  1  2
0  1  2  3
1  2  3  4
>>> data.max()
0    2
1    3
2    4
dtype: int64
    """
    data_max=data_piece.max()
    data_min=data_piece.min()
    #得到变化范围
    height_Series= data_max-data_min
    height_PVT = height_Series[PVT]
    height_label = height_Series[label]

    #计算两个跳空系数，可以画个图看看
    #high_jump 希望价格相对高点降了很多但是成交量比较少
    diff = data_max-data_piece.iloc[-1]
    delta_PVT=diff[PVT];delta_label=diff[label]
    high_jump = np.log(delta_label/height_label/(delta_PVT/height_PVT)) if delta_label>0 and delta_PVT>0 else -1
    #low_jump 希望价格相对低点升了一点，但是成交量很多
    diff = data_piece.iloc[-1]-data_min
    delta_PVT=diff[PVT];delta_label=diff[label]
    low_jump = np.log((delta_PVT/height_PVT)/(delta_label/height_label)) if delta_label>0 and delta_PVT>0 else -1
    #这两者的意义可以相加吗？ 还有待商榷
    jump_air_factor = (high_jump+low_jump)/2
    
    #选取短些的日期再次计算
    label='close';data_piece=codata.tail(55)[[PVT,label]];
    data_max=data_piece.max();data_min=data_piece.min();
    height_Series= data_max-data_min;
    height_PVT = abs(height_Series[PVT]);height_label = abs(height_Series[label]);
    diff = data_piece.iloc[-1]-data_min;
    delta_PVT=diff[PVT];delta_label=diff[label];

    #安全系数，总共涨的的量比去已经涨的量，越大越好
    safe_coeff = (np.log( (height_PVT/2/delta_PVT)) +np.log(height_label/2/delta_label) )/2 if delta_label>0 and delta_PVT>0 else -1;

    #翱翔系数，最小价格比去已经相距最低点上涨的量，比值越大越好
    up_soar = np.log(data_min[label]/diff[label]/2) if diff[label]>0 else 0;

    comprehension_jump_air = np.mean( [safe_coeff,jump_air_factor,up_soar] )
    #print comprehension_jump_air,jump_air_factor,safe_coeff,up_soar ;
    return comprehension_jump_air;

def water_level(codata, input_s=''):
    """
    统计前期的 上张幅度，上涨总量价，上涨天数等的量，作为水位最大值，计算现值与最小值的差与水位最大值的关系
    :param codata:
    :param input_s:
    :return:
    """
    #一些指标以及数据初始化
    p_change=input_s+'p_change';PVT=input_s+'PVT';dist2last_min=input_s+'dist2last_min';dist2last_max=input_s+'dist2last_max'
    ll=codata.iloc[-1];max_1_base=ll[dist2last_max]+1;close='close'if input_s=='' else input_s[:-1]
    min_1_base=ll[dist2last_min]+1
    Positive_net  =  Negative_net  =  Postive_P_sum  =  Positive_days  =  0.0
    #Positive_net:总的上涨幅度，Negative_net:总的下跌幅度，Positive_P_sum:总的上涨量价PVT，Positive_days:总的上涨天数

    #确定前n个周期的起始索引
    min_periods_index=min_1_base; periods = 3
    for i in range(periods):
        try:
            min_periods_index = codata.iloc[-min_periods_index][dist2last_min]+min_periods_index
        except:
            min_periods_index=len(codata);break
    min_periods_index=min(min_periods_index,len(codata))

    #计算各个统计量
    min_PVT=base=float('inf')
    for i in range(min_1_base,min_periods_index):
        temp=codata.iloc[-i];p_c=temp[p_change];cl=temp[close];vl=temp['volume'];pv= p_c*vl
        if p_c>0:
            Positive_net+=p_c;Positive_days+=1;Postive_P_sum+=pv
        else :
            Negative_net+=p_c
        if cl<base:
            base=cl;min_PVT=temp[PVT]
    upDaysMax = Positive_days / float(periods)      #平均每个周期上涨的天数，下类同
    up_p_change_max = Positive_net / periods
    up_pv_sum_max = Postive_P_sum / periods

    #计算现状距离最低点
    upDaysNow = sum(codata.iloc[-min_1_base:][p_change].values>0)
    up_p_change_Now=(ll[close]-base)/base*100
    up_pv_sum_Now=(ll[PVT]-min_PVT)
    #计算各个剩余的预期潜力希望
    hope_p_change = up_p_change_max-up_p_change_Now
    hope_pv_sum=up_pv_sum_max-up_pv_sum_Now
    hope_updays=upDaysMax-upDaysNow
    #转换成比例分数，去除量纲和基数的影响
    hope_p_change_f=hope_p_change/up_p_change_max if hope_p_change>0 else 0
    hope_pv_sum_f=hope_pv_sum/up_pv_sum_max if hope_pv_sum>0 else 0
    hope_updays_f=hope_updays/upDaysMax if hope_updays>0 else 0

    # 这里因为Negative_net是负数，所以其实分母是两个量的绝对值和，分子是两个量的绝对值差
    # 用这个计算量P2E来描述是否振荡态
    P2E=(Positive_net+Negative_net)/(Positive_net-Negative_net)

    #凯利公式计算最优仓位
    if 0.55>P2E>-0.25 and hope_p_change>0 and (min_1_base<max_1_base or hope_p_change>9.5):
        #振荡态 and ( 还在上涨的半周期{equivalent to "min_1_base<max_1_base"} or 还有很大涨幅like 9.5 ）
        S=up_p_change_Now+5.5       #赌注
        B=hope_p_change             #赔率
        L=1/(P2E+1+hope_p_change_f+hope_pv_sum_f+hope_updays_f+np.log(hope_p_change))
        P=np.e**(-np.pi*L*L);Q=1-P  #均值为0的，最大概率密度为1的正太概率密度函数,用来直接映射到概率
        C=(P*B-Q*S)/(B*S)
        print '胜率:',P,'负率:',Q,'赔率:',B,'赌注:',S,'仓位:',C
    else:C=0
    print 'hope_p_change_f:',hope_p_change_f, "hope_pv_sum_f",hope_pv_sum_f, 'hope_updays_f',hope_updays_f,\
        'P2E',P2E,'hope',hope_p_change,'up_p_change_Now',up_p_change_Now,
    return C if C>0 else 0
def weighted_water_level(codata, input_s=['', 'ema3_', 'ema5_', 'pseudo_mean_price_'], weight=[0.4, 0.3, 0.2, 0.1]):
    return util.type_data(sum([tp[1] * water_level(codata=codata, input_s=tp[0]) for tp in zip(input_s, weight)]));

def after_big_drop_positive_residual_propotion(codata,input_s="ema5_"):
    if len(codata) <25:return 0
    #一些指标以及数据初始化
    p_change='p_change'
    dist2last_min=input_s+'dist2last_min'
    ll=codata.iloc[-1]
    min_1_base=min(ll[dist2last_min]+1,len(codata) )
    dist2last_big_drop = min(ll["dist2last_big_drop"],150)
    min2min = min(codata.iloc[-min_1_base][dist2last_min]+1 +min_1_base,len(codata) )
    # ±成交量累积量,±天数，注意初始化为浮点数0.0，便于后续的小数计算
    Positive_net = Negative_net = Positive_Days = Negative_Days = 0.0
    if min2min<dist2last_big_drop and 255>dist2last_big_drop - min_1_base:
        lenth = dist2last_big_drop-min_1_base
        weights = np.array([1.0/lenth]*lenth)
        decays = np.log( np.array(range(2,2+lenth)) )
        weights_decayed = weights*decays
        weights_decayed = np.flip( weights_decayed,axis=0)
        for i in range(min_1_base,dist2last_big_drop):
            temp = codata.iloc[-i]
            p_c = temp[p_change]
            vl = temp['volume']
            if p_c > 0:
                Positive_net  += vl*weights_decayed[i-min_1_base]
                Positive_Days += 1*weights_decayed[i-min_1_base]
            else:
                Negative_net  += vl*weights_decayed[i-min_1_base]
                Negative_Days += 1*weights_decayed[i-min_1_base]
        #这两项可以约束住有较大的成交量在正方向
        positive_residual_propotion = Positive_net/(Negative_net+Positive_net)  #要小心python2 的整数整除
        days_residual_propotion     = Positive_Days/(Negative_Days+Positive_Days)  #上涨天数比去总天数，希望上涨天数多一些
        #这一项约束住有正方向成交量但被操作住股价没有相对大涨
        upNow_pc = ll["close"]/codata.iloc[-dist2last_big_drop]["close"] - 1
        upNow    = (upNow_pc+1.8)/1.8
        d2lbd = dist2last_big_drop#天数太短或太长的惩罚
        dist2last_big_drop_punish = \
            np.log(d2lbd)/np.log(18) if d2lbd<25 else 15.0/d2lbd+0.8 if d2lbd>50 else 1.1
        result   = 2.25 * positive_residual_propotion * days_residual_propotion / upNow * dist2last_big_drop_punish
        if __name__=="__main__":
            print(result,positive_residual_propotion,days_residual_propotion,upNow,upNow_pc)
    else:result = 0
    return result

def column_generated(codata,column_name="new",compute_f=lambda x:0,start=0,end=None):
    if end == None:end = len(codata)
    if column_name not in codata.columns:codata[column_name] = 0
    column_ix = codata.columns.tolist().index(column_name)
    for ix in range(start,end):
        temp  = codata.iloc[:ix+1]
        value = compute_f(temp)
        codata.iloc[ix,column_ix] = value

#便于变相函数持久化,数据量要求小的算法 排在前面
func_name_address = {'default':default_fun,'kdj_ema_quick_d':kdj_ema_quick_d,\
                     'quantity_potiential_judge':quantity_potiential_judge,'macd_diff_judge':macd_diff_judge,\
                    'naive_bayes':naive_bayes,'env_relative_judge':env_relative_judge,\
                    'hmm_state':hmm_state,'ml_svm_predict':ml_svm_predict,'damped_vibration':damped_vibration_fitting,\
                    'discrete_F_T_predict_fitting':discrete_F_T_predict_fitting,'temp_test':temp_test}


def get_optimized_func_of_codes_by_sequence_similarity(codata):
    import copy
    #print 'entering get_optimized_func_of_codes_by_sequence_similarity:',
    d_num=25;y=codata.tail(d_num)['close'].tolist();   wanted_index=0;max_cos=-1;
    previous_codata = codata.drop([codata.index[-1]])
    for i in range(len(previous_codata)-d_num):
        x = previous_codata.head(i+d_num).tail(d_num)['close'].tolist();
        temp_cos=util.vector_cos(x, y)
        if temp_cos>max_cos:
            max_cos=temp_cos;wanted_index=i
    temp_codata = codata
    temp_func_map = copy.copy(func_name_address)
    for i in range(wanted_index,len(codata)):
        if len(temp_func_map)==1: break
        else: 
            list_keys = list(temp_func_map.keys())
            for key in list_keys:
                func=temp_func_map[key] #RuntimeError: dictionary changed size during iteration
                if len(temp_func_map)<=1: 
                    temp_func_map ={ temp_func_map.keys()[0]:temp_func_map[temp_func_map.keys()[0]]}
                    break
                else:
                    if i+d_num+1>=len(temp_codata):
                        temp_func_map = {temp_func_map.keys()[0]:temp_func_map[temp_func_map.keys()[0]]}
                        break
                    predictor_codata =temp_codata.head(i+d_num); y_codata = temp_codata.head(i+d_num+1).tail(1)
                    #print func(predictor_codata),y_codata['p_change'].item()
                    #print predictor_codata.tail(1),y_codata
                    if util.xor(func(predictor_codata), y_codata['p_change'].item()>0):
                        #print 'temp_func_map.pop(key)'
                        temp_func_map.pop(key)
        #print len(temp_func_map),temp_func_map.keys()
    wanted_func_name = temp_func_map.keys()[0]
    print 'leaving:',wanted_func_name
    wanted_func = temp_func_map[wanted_func_name]
    return wanted_func(codata)


#macd天数和上市天数的积 选择偏向次新和macd少的 附加一个成交额门限
def in_market_days_mul_macd_d_greater_0_num(codata):
    return True
    lastdata = codata.tail(1);last_judge = lastdata['MACD_d'].item()>0 and lastdata['p_change'].item()>0
    num = 0;in_market_days_mul_macd_d_greater_0_num_thresh = 2**12
    for index,row in codata.tail(5).iterrows():
        if row['MACD_d']>0:num+=1
    return last_judge and num*len(codata)<in_market_days_mul_macd_d_greater_0_num_thresh and lastdata['amount'].item()>mlcst.Amount_thresh\
        and abs(lastdata['p_change'].item())<6

#变异系数 -- 描述股价波动情况,计算类似方差,但是可以除以均值,使得各个股票可以在基数不一样情况下,比较波动
def getCoefficient_of_Variation(codata):
    close = codata['close']
    narray=np.array(close)
    sum1=narray.sum()
    narray2=narray*narray
    sum2=narray2.sum()
    N = len(close)
    mean=sum1/N
    var=sum2/N-mean**2
    if var==0:
        var = mean/100+0.1
    Coefficient_of_Variation = var/mean/mean
    return Coefficient_of_Variation

def recommend_table_generator(predict_table,codata_basic_code_mapping=None):
    print 'entering recommend_table_generator ,original predict_table len: ',len(predict_table)

    #进行一些约束
    # mean__Coefficient_of_Variation=float('-inf')
    # recommend_table = predict_table[( (predict_table['additional_judge']==True) & (predict_table['Coefficient_of_Variation']>=mean__Coefficient_of_Variation) )]
    # recommend_table.sort_values(by="Coefficient_of_Variation" , ascending=False,inplace=True)
    predict_table.sort_values(by="Coefficient_of_Variation", ascending=False, inplace=True)
    recommend_table = predict_table
    print 'recommend_table len: ',len(recommend_table),recommend_table

    # 部分截取,回收内存
    tail_n =155
    topN=recommend_table.head(tail_n)
    for code  in codata_basic_code_mapping.keys():
        if code not in topN.index:del codata_basic_code_mapping[code]
        else:
            temp_codata = codata_basic_code_mapping[code][0]
            codata_basic_code_mapping[code] = \
            (temp_codata.tail(int(temp_codata.iloc[-1]["dist2last_big_drop"]*1.1)),codata_basic_code_mapping[code][1])
    import gc
    gc.collect()

    #绘图
    i = 0
    for code,_ in topN.iterrows():
        codata,_=codata_basic_code_mapping.pop(code)
        #这里的reset_index 有将数据reverse功能，符合靠右的是时间近的
        # codata  = codata[['PVT','VT','close']].reset_index(drop=True)
        # codata.rename(columns={'PVT':'pseudo_mean_price'},inplace=True)
        codata = codata[["MACD_d","close","p_change","volume","new"]].reset_index(drop=True)
        p_c_sign = np.sign(codata["p_change"].values)
        p_c_sign[p_c_sign==0] = 1
        codata["volume"] = codata["volume"].values * p_c_sign
        codata.plot(subplots=True,grid=True)
        plt.savefig(dtcst.cweb_analyzer_path+code+'.png')
        plt.close()
        if i%10 == 0:print("saved pics num is ",i,)
        i  = i+1
    print '\n savefig done'

    return util.type_data(recommend_table)

def default_run_all():
    ml_all(realtime_data = pd.read_csv(dtcst.My_Store_Dir+'realtime_data.csv').set_index('code'))

if __name__ == '__main__':
    print '模块测试'
    default_run_all()